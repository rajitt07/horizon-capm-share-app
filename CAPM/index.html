<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sector Input</title>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        max-width: 760px;
        margin: 40px auto;
        padding: 0 16px;
        background: #0b0d12;
        color: #e6e8ee;
      }
      h1 {
        font-size: 28px;
        margin-bottom: 20px;
      }
      .card {
        background: #141823;
        border: 1px solid #20263a;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      .panel {
        background: #141823;
        border: 1px solid #20263a;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      form {
        display: grid;
        gap: 16px;
      }
      .form-group {
        display: grid;
        gap: 12px;
      }
      .input-row {
        display: grid;
        gap: 16px;
      }
      .inline-row {
        display: flex;
        gap: 12px;
        align-items: stretch;
      }
      .inline-row input {
        flex: 1;
      }
      .field {
        display: flex;
        flex-direction: column;
      }
      .output {
        padding: 14px;
        border: 1px solid #2a3350;
        border-radius: 10px;
        background: linear-gradient(180deg, #0f1320 0%, #101526 100%);
      }
      .section-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #9aa3b2;
        margin: 0 0 10px 2px;
      }
      .inline-row {
        display: flex;
        gap: 12px;
        align-items: stretch;
      }
      .inline-row input {
        flex: 1;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }
      input,
      select {
        width: 100%;
        padding: 9px 12px;
        font-size: 16px;
        height: 38px;
        background: #0f1320;
        color: #e6e8ee;
        border: 1px solid #2a3350;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      input:focus,
      select:focus {
        border-color: #6ea8fe;
        box-shadow: 0 0 0 3px rgba(110, 168, 254, 0.2);
      }
      input::placeholder {
        color: #6f7890;
      }
      .ghost-button {
        white-space: nowrap;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 600;
        border: 1px solid #2a3350;
        border-radius: 999px;
        background: #0f1320;
        color: #e6e8ee;
        cursor: pointer;
        height: 38px;
        width: fit-content;
        transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease, transform 0.08s ease;
      }
      .ghost-button:hover {
        border-color: #6ea8fe;
        color: #cfe0ff;
      }
      .ghost-button.is-active,
      .ghost-button[aria-pressed="true"] {
        background: #1f6feb;
        border-color: #6ea8fe;
        color: #ffffff;
        box-shadow: 0 0 0 4px rgba(31, 111, 235, 0.25);
      }
      .ghost-button.is-active::after {
        content: " â€¢ ON";
      }
      .hint {
        color: #9aa3b2;
        font-size: 12px;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <h1>Sector Inputs</h1>
    <div class="panel">
      <div class="section-title">Inputs</div>
      <form>
        <div class="input-row">
          <div class="field">
            <label for="year">Year</label>
            <div class="inline-row">
              <select id="year" name="year">
                <option value="" selected disabled>Select a year</option>
              </select>
              <input
                id="year-manual"
                name="yearManual"
                type="number"
                min="1900"
                max="2100"
                style="display: none;"
                placeholder="Enter year"
              />
              <button
                type="button"
                class="ghost-button"
                data-toggle="override"
                data-target="year"
                aria-pressed="false"
              >
                Manual Override
              </button>
            </div>
            <div class="hint">Select from the list or enable manual override.</div>
          </div>
          <div class="field">
            <label for="rf-value">Rf Value</label>
            <div class="inline-row">
              <input id="rf-value" name="rfValue" type="number" step="0.01" readonly />
              <button
                type="button"
                class="ghost-button"
                data-toggle="override"
                data-target="rf-value"
                aria-pressed="false"
              >
                Manual Override
              </button>
            </div>
            <div class="hint">Example: 6.5</div>
          </div>
        </div>
        <div class="form-group">
          <div>
            <label for="cagr">CAGR</label>
            <input id="cagr" name="cagr" type="number" step="0.01" />
            <div class="hint">Example: 12.5</div>
          </div>
          <div>
            <label for="sector">Sector</label>
            <select id="sector" name="sector">
              <option value="" selected disabled>Select a sector</option>
              <option value="BSE AUTO">BSE AUTO</option>
              <option value="BSE BANKEX">BSE BANKEX</option>
              <option value="BSE CONSUMER DURABLES">BSE CONSUMER DURABLES</option>
              <option value="BSE CAPITAL GOODS">BSE CAPITAL GOODS</option>
              <option value="BSE Commodities">BSE Commodities</option>
              <option value="BSE Consumer Discretionary">BSE Consumer Discretionary</option>
              <option value="BSE Energy.">BSE Energy.</option>
              <option value="BSE Financial Services">BSE Financial Services</option>
              <option value="BSE Industrials">BSE Industrials</option>
              <option value="BSE Fast Moving Consumer Goods">BSE Fast Moving Consumer Goods</option>
              <option value="BSE Telecommunication">BSE Telecommunication</option>
              <option value="BSE Utilities">BSE Utilities</option>
              <option value="BSE Healthcare">BSE Healthcare</option>
              <option value="BSE Information Technology.">BSE Information Technology.</option>
              <option value="BSE METAL">BSE METAL</option>
              <option value="BSE OIL & GAS">BSE OIL & GAS</option>
              <option value="BSE POWER">BSE POWER</option>
              <option value="BSE REALTY">BSE REALTY</option>
              <option value="BSE TECK">BSE TECK</option>
              <option value="BSE Services">BSE Services</option>
              <option value="BSE Focused IT">BSE Focused IT</option>
            </select>
            <div class="hint">Options will be added later.</div>
          </div>
          <div>
            <label for="beta-score">Beta Score</label>
            <div class="inline-row">
              <input id="beta-score" name="betaScore" type="number" step="0.01" readonly />
              <button
                type="button"
                class="ghost-button"
                data-toggle="override"
                data-target="beta-score"
                aria-pressed="false"
              >
                Manual Override
              </button>
            </div>
            <div class="hint">Example: 1.15</div>
          </div>
        </div>
      </form>
    </div>
    <div class="panel" style="margin-top: 20px;">
      <div class="section-title">Output</div>
      <div class="output">
        <label for="expected-return">Expected Return</label>
        <input id="expected-return" name="expectedReturn" type="number" step="0.01" readonly />
        <div class="hint">Calculated output will appear here.</div>
      </div>
    </div>
    <script>
      document.querySelectorAll("[data-toggle='override']").forEach((button) => {
        button.addEventListener("click", () => {
          const isActive = button.getAttribute("aria-pressed") === "true";
          const nextState = !isActive;
          button.setAttribute("aria-pressed", String(nextState));
          button.classList.toggle("is-active", nextState);

          const target = button.getAttribute("data-target");
          if (target === "year") {
            const yearSelect = document.getElementById("year");
            const yearManual = document.getElementById("year-manual");
            if (yearSelect && yearManual) {
              yearSelect.style.display = nextState ? "none" : "";
              yearManual.style.display = nextState ? "" : "none";
              yearSelect.disabled = nextState;
              yearManual.disabled = !nextState;
              yearManual.readOnly = !nextState;
              if (nextState) {
                yearManual.focus();
              }
            }
            return;
          }

          const input = target ? document.getElementById(target) : null;
          if (input) {
            input.readOnly = !nextState;
            input.disabled = !nextState;
            if (nextState) {
              input.focus();
            }
          }
        });
      });

      const rfByYear = {
        2025: 6.4,
        2024: 7.16,
        2023: 7.12,
        2022: 7.15,
        2021: 6.26,
        2020: 6.55,
        2019: 7.44,
        2018: 7.8,
        2017: 7.2,
        2016: 7.44,
      };

      const yearSelect = document.getElementById("year");
      const yearManual = document.getElementById("year-manual");
      const rfInput = document.getElementById("rf-value");
      const betaInput = document.getElementById("beta-score");
      const sectorSelect = document.getElementById("sector");
      const betaOverrideButton = document.querySelector("[data-target='beta-score']");
      const cagrInput = document.getElementById("cagr");
      const expectedReturnInput = document.getElementById("expected-return");
      const betaCsvUrl = "../test%20arena/CODEX-beta.csv";
      const sectorToCsvFile = {
        "BSE AUTO": "BSE sector AUTO.csv",
        "BSE BANKEX": "BSE BANKEX.csv",
        "BSE CONSUMER DURABLES": "BSE consumer durables.csv",
        "BSE CAPITAL GOODS": "BSE sectoral CAP goods.csv",
        "BSE Consumer Discretionary": "BSE secotral Conusmer discretionary.csv",
        "BSE Energy.": "BSE energy.csv",
        "BSE Financial Services": "BSE finserv.csv",
        "BSE Industrials": "BSE industries.csv",
        "BSE Fast Moving Consumer Goods": "BSE FMCG.csv",
        "BSE Utilities": "BSE utilities.csv",
        "BSE Healthcare": "BSE healthcare.csv",
        "BSE Information Technology.": "BSE IT.csv",
        "BSE METAL": "BSE METAL.csv",
        "BSE OIL & GAS": "BSE OIL and GAS.csv",
        "BSE POWER": "BSE power and energy.csv",
        "BSE REALTY": "BSE REALTY.csv",
        "BSE Services": "BSE services.csv",
      };
      let betaByFile = {};
      if (yearSelect && rfInput) {
        Object.keys(rfByYear)
          .sort((a, b) => Number(b) - Number(a))
          .forEach((year) => {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
          });

        yearSelect.addEventListener("change", () => {
          if (rfInput.readOnly) {
            const rfValue = rfByYear[yearSelect.value];
            rfInput.value = rfValue !== undefined ? String(rfValue) : "";
            updateExpectedReturn();
          }
        });
      }

      function updateExpectedReturn() {
        if (!expectedReturnInput || !rfInput || !betaInput || !cagrInput) {
          return;
        }
        const rf = parseFloat(rfInput.value);
        const beta = parseFloat(betaInput.value);
        const cagr = parseFloat(cagrInput.value);
        if (Number.isNaN(rf) || Number.isNaN(beta) || Number.isNaN(cagr)) {
          expectedReturnInput.value = "";
          return;
        }
        const expected = rf + beta * (cagr - rf);
        expectedReturnInput.value = String(expected);
      }

      function parseCsvRow(line) {
        const values = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i += 1) {
          const char = line[i];
          if (char === '"' && line[i + 1] === '"') {
            current += '"';
            i += 1;
          } else if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === "," && !inQuotes) {
            values.push(current);
            current = "";
          } else {
            current += char;
          }
        }
        values.push(current);
        return values;
      }

      function isBetaManualOverrideEnabled() {
        return betaOverrideButton?.getAttribute("aria-pressed") === "true";
      }

      function applyAutoBetaForSelectedSector() {
        if (!sectorSelect || !betaInput) {
          return;
        }
        if (isBetaManualOverrideEnabled()) {
          return;
        }
        const selectedSector = sectorSelect.value;
        const csvFile = sectorToCsvFile[selectedSector];
        const betaValue = csvFile ? betaByFile[csvFile] : undefined;
        betaInput.value = Number.isFinite(betaValue) ? String(betaValue) : "";
        updateExpectedReturn();
      }

      async function loadBetaCsvData() {
        try {
          const response = await fetch(betaCsvUrl);
          if (!response.ok) {
            throw new Error(`Unable to load beta CSV (${response.status}).`);
          }
          const csvText = await response.text();
          const lines = csvText.split(/\r?\n/).filter((line) => line.trim().length > 0);
          if (lines.length < 2) {
            return;
          }
          const header = parseCsvRow(lines[0]);
          const fileIndex = header.indexOf("file");
          const betaIndex = header.indexOf("beta");
          if (fileIndex === -1 || betaIndex === -1) {
            return;
          }
          const parsed = {};
          for (let i = 1; i < lines.length; i += 1) {
            const row = parseCsvRow(lines[i]);
            const fileName = (row[fileIndex] || "").replace(/^"|"$/g, "").trim();
            const betaValue = Number.parseFloat((row[betaIndex] || "").trim());
            if (fileName && Number.isFinite(betaValue)) {
              parsed[fileName] = betaValue;
            }
          }
          betaByFile = parsed;
          applyAutoBetaForSelectedSector();
        } catch (error) {
          console.error("Failed to fetch beta values from CSV.", error);
        }
      }

      [rfInput, betaInput, cagrInput, yearManual].forEach((el) => {
        if (el) {
          el.addEventListener("input", updateExpectedReturn);
        }
      });

      if (sectorSelect) {
        sectorSelect.addEventListener("change", applyAutoBetaForSelectedSector);
      }
      if (betaOverrideButton) {
        betaOverrideButton.addEventListener("click", () => {
          setTimeout(() => {
            applyAutoBetaForSelectedSector();
          }, 0);
        });
      }
      loadBetaCsvData();
    </script>
  </body>
</html>
